---
title: "Function Usage"
date: "`r Sys.Date()`"
format: 
  html:
    df-print: paged
editor: visual
embed-resources: true
---

## Source functions from imd-fetchaquarius and establish connection to API

```{r Connect-to-Aquarius}
#| message: false
#| warning: false
library(tidyverse)

# Source functions from imd-fetchaquarius
source("https://raw.githubusercontent.com/nationalparkservice/imd-fetchaquarius/refs/heads/main/R/timeseries_client.R")
source("https://raw.githubusercontent.com/nationalparkservice/imd-fetchaquarius/refs/heads/main/R/retrieve_data.R")

# set username and then enter password
# keyring::key_set("aquarius", "aqreadonly")

# establish connection
connectToAquarius("aqreadonly")
```

```{r get-wl-data}
#| message: false
#| warning: false

source("C:/Users/lfeher/OneDrive - DOI/NCBNAqua/R/calc_longest_flood.R")
source("C:/Users/lfeher/OneDrive - DOI/NCBNAqua/R/calc_flood_events.R")
source("C:/Users/lfeher/OneDrive - DOI/NCBNAqua/R/calc_time_flooded.R")
source("C:/Users/lfeher/OneDrive - DOI/NCBNAqua/R/calc_daily_mean_flood.R")
source("C:/Users/lfeher/OneDrive - DOI/NCBNAqua/R/calc_flood_depths.R")
source("C:/Users/lfeher/OneDrive - DOI/NCBNAqua/R/get_wl_data.R")
source("C:/Users/lfeher/OneDrive - DOI/NCBNAqua/R/calc_tidal_datums.R")
source("C:/Users/lfeher/OneDrive - DOI/NCBNAqua/R/find_extremes.R")

# set the site order 
site_order <- c("Marsh 5 (Pope Bay)", "Marsh 6 (Pine Tree)", "Marsh 8 (Valentines)", "Marsh 11", "Exclosures", "Pine Tree Study")

# Get water level data for each site
asis_wl <- get_wl_data(park = "ASIS") %>%
  mutate(
    site_name = case_when(
      LocationIdentifier == "ASIS_M5_WaterLevel" ~ "Marsh 5 (Pope Bay)",
      LocationIdentifier == "ASIS_M6_WaterLevel" ~ "Marsh 6 (Pine Tree)",
      LocationIdentifier == "ASIS_M8_WaterLevel" ~ "Marsh 8 (Valentines)",
      T ~ "unknown"),
    site_name = if_else(site_name != "unknown", forcats::fct_relevel(site_name, site_order), forcats::as_factor(site_name))) %>%
  group_by(Name, Identifier, LocationIdentifier, park, site_name)

head(asis_wl)
```

```{r calc-tidal-datums}
#| message: false
#| warning: false
asis_tidal_datums <- calc_tidal_datums(asis_wl)

head(asis_tidal_datums)
```

```{r calc-flood-depths}
#| message: false
#| warning: false
# Average minimum daily flood depth, an indicator of marsh drainage, was calculated as the average difference between the daily minimum water elevation and the marsh elevation at each site. See Stagg et al. 2020  

asis_elev_df <- data.frame(LocationIdentifier = c("ASIS_M5_WaterLevel", "ASIS_M6_WaterLevel", "ASIS_M8_WaterLevel"), elev_navd88 = c(0.145, 0.1325, 0.200))

asis_flood_depths <- calc_flood_depths(wl_data = asis_wl, elev_df = asis_elev_df)

head(asis_flood_depths)
```

```{r calc-daily-mean-min-flood-depth-height}
#| message: false
#| warning: false
asis_daily_mean_min_flood <- calc_daily_mean_flood(flood_depths_df = asis_flood_depths, summary_metric = "min")

head(asis_daily_mean_min_flood)
```

```{r calc-daily-mean-mean-flood-depth-height}
#| message: false
#| warning: false
asis_daily_mean_mean_flood <- calc_daily_mean_flood(asis_flood_depths, summary_metric = "mean")

head(asis_daily_mean_mean_flood)
```

```{r calc-percent-time-flooded}
#| message: false
#| warning: false
asis_time_flooded <- calc_time_flooded(asis_flood_depths)

head(asis_time_flooded)
```

```{r calc-num-flood-events}
#| message: false
#| warning: false
asis_flood_events <- calc_flood_events(flood_depths_df = asis_flood_depths)

head(asis_flood_events)
```

```{r calc-longest-flood-event}
#| message: false
#| warning: false
asis_longest_flood <- calc_longest_flood(asis_flood_depths)

head(asis_longest_flood)
```

```{r park-level-averages}
#| message: false
#| warning: false
asis_mean_hydro <- asis_wl %>%
  summarise(first_date = first(datetime),
            last_date = last(datetime),
            .groups = "keep") %>% 
  left_join(., asis_daily_mean_min_flood) %>%
  left_join(., asis_daily_mean_mean_flood) %>%
  left_join(., asis_time_flooded)  %>%
  left_join(., asis_flood_events) %>%
  left_join(., asis_longest_flood) %>%
  left_join(., asis_tidal_datums) %>%
  ungroup(-park) %>%
  summarise(across(c(elev_navd88, daily_mean_min_flood_depth, daily_mean_min_flood_elev, daily_mean_flood_depth, daily_mean_flood_elev, total_time_recorded, flooding_time, percent_time_flooded, total_flood_events, max_consecutive_flood_days, MHW, MHHW, MLW, MLLW), ~mean(.x, na.rm = TRUE), .names = "park_{.col}"))

head(asis_mean_hydro)
```
